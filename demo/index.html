<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website Python/Flask Cơ Bản</title>
    <!-- Tải Tailwind CSS để tạo giao diện đẹp và responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Sử dụng font Inter cho thẩm mỹ */
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-6xl">
        <div class="flex gap-6">
            <!-- Left: controls -->
            <div class="w-1/3 p-4">
                <h1 class="text-2xl font-bold mb-3">Detection</h1>
                <div class="mb-4">
                    <label class="block text-left mb-2">Kích thước lưới (rows x cols):</label>
                    <div class="flex gap-2">
                        <input id="rowsInput" type="number" min="1" value="4" class="w-1/2 px-3 py-2 border rounded" />
                        <input id="colsInput" type="number" min="1" value="6" class="w-1/2 px-3 py-2 border rounded" />
                    </div>
                </div>

                <div id="dropArea" class="mb-4 p-4 border-2 border-dashed rounded text-gray-500">
                    Kéo thả ảnh hoặc video vào đây, hoặc <label for="fileInput" class="text-blue-600 underline cursor-pointer">chọn file</label>.
                    <input id="fileInput" type="file" accept="image/*,video/*" class="hidden" />
                </div>

                <button id="uploadButton" class="w-full bg-blue-600 text-white font-semibold py-2 rounded-lg shadow hover:bg-blue-700 mb-3">
                    Tải lên và Xử lý
                </button>

                <div class="mb-3">
                    <button id="startWebcam" class="w-full bg-green-600 text-white py-2 rounded mb-2">Bật Webcam</button>
                    <button id="stopWebcam" class="w-full bg-red-500 text-white py-2 rounded">Tắt Webcam</button>
                </div>

                <p id="statusText" class="text-sm text-gray-600">Chưa có dữ liệu</p>
            </div>

            <!-- Right: display (image/video + heatmap) -->
            <div class="flex-1 p-4" id="displayArea">
                <div id="previewArea" class="mb-4"></div>
            </div>
        </div>
    </div>

    <script>
        // Drag & drop + file input handling
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const uploadButton = document.getElementById('uploadButton');
        const previewArea = document.getElementById('previewArea');
        const statusText = document.getElementById('statusText');

        let selectedFile = null;

        ['dragenter', 'dragover'].forEach(evt => dropArea.addEventListener(evt, (e) => { e.preventDefault(); dropArea.classList.add('bg-blue-50'); }));
        ['dragleave', 'drop'].forEach(evt => dropArea.addEventListener(evt, (e) => { e.preventDefault(); dropArea.classList.remove('bg-blue-50'); }));

        dropArea.addEventListener('drop', (e) => {
            const f = e.dataTransfer.files[0];
            if (f) selectFile(f);
        });

        fileInput.addEventListener('change', (e) => { if (e.target.files && e.target.files[0]) selectFile(e.target.files[0]); });

        function selectFile(f) {
            selectedFile = f;
            previewArea.innerHTML = '';
            if (f.type.startsWith('image')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(f);
                img.style.maxWidth = '100%';
                previewArea.appendChild(img);
            } else if (f.type.startsWith('video')) {
                const v = document.createElement('video');
                v.src = URL.createObjectURL(f);
                v.controls = true; v.style.maxWidth = '100%';
                previewArea.appendChild(v);
            } else {
                previewArea.textContent = 'File không hợp lệ';
            }
            statusText.textContent = `Đã chọn: ${f.name}`;
        }

        uploadButton.addEventListener('click', async () => {
            if (!selectedFile) { statusText.textContent = 'Vui lòng chọn file trước.'; return; }
            const rows = document.getElementById('rowsInput').value || 4;
            const cols = document.getElementById('colsInput').value || 6;

            const form = new FormData();
            form.append('file', selectedFile);
            form.append('rows', rows);
            form.append('cols', cols);

            statusText.textContent = 'Đang tải lên và xử lý...';
            try {
                const resp = await fetch('/api/process_media', { method: 'POST', body: form });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.message || 'Server error');
                statusText.textContent = 'Hoàn thành. Hiển thị kết quả.';
                previewArea.innerHTML = '';
                if (data.type === 'image') {
                    const img = document.createElement('img');
                    img.src = data.result; img.style.maxWidth = '100%';
                    previewArea.appendChild(img);
                } else if (data.type === 'video') {
                    // If server returned a stream URL, show a Stream button
                    if (data.stream) {
                        const streamId = data.stream_id;
                        const btn = document.createElement('button');
                        btn.textContent = 'Phát (Stream xử lý)';
                        btn.className = 'w-full bg-indigo-600 text-white py-2 rounded mb-2';
                        btn.onclick = () => {
                            // create img stream and stop button
                            const img = document.createElement('img');
                            img.src = data.stream;
                            img.style.maxWidth = '100%';
                            img.alt = 'Processed video stream';
                            previewArea.innerHTML = '';
                            previewArea.appendChild(img);

                            const stopBtn = document.createElement('button');
                            stopBtn.textContent = 'Dừng xử lý';
                            stopBtn.className = 'w-full bg-red-600 text-white py-2 rounded mt-2';
                            stopBtn.onclick = async () => {
                                try {
                                    await fetch('/stop_stream', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({stream_id: streamId}) });
                                    img.remove();
                                    stopBtn.remove();
                                    statusText.textContent = 'Stream đã được dừng.';
                                } catch (err) {
                                    statusText.textContent = 'Lỗi khi dừng stream: ' + err.message;
                                }
                            };
                            previewArea.appendChild(stopBtn);
                        };
                        previewArea.appendChild(btn);
                        // also show a regular video link to the uploaded file if provided
                        if (data.uploaded) {
                            const a = document.createElement('a');
                            a.href = data.uploaded; a.textContent = 'Tải video gốc'; a.target = '_blank';
                            a.className = 'block mt-2 text-sm text-gray-600';
                            previewArea.appendChild(a);
                        }
                    } else if (data.result) {
                        const v = document.createElement('video');
                        v.src = data.result; v.controls = true; v.style.maxWidth = '100%';
                        previewArea.appendChild(v);
                    }
                }
            } catch (err) {
                statusText.textContent = 'Lỗi: ' + err.message;
            }
        });

        // Webcam controls
        const startWebcam = document.getElementById('startWebcam');
        const stopWebcam = document.getElementById('stopWebcam');
        let webcamImg = null;

        startWebcam.addEventListener('click', () => {
            const rows = document.getElementById('rowsInput').value || 4;
            const cols = document.getElementById('colsInput').value || 6;
            const url = `/webcam_stream?rows=${rows}&cols=${cols}`;
            if (webcamImg) return;
            webcamImg = document.createElement('img');
            webcamImg.src = url;
            webcamImg.style.maxWidth = '100%';
            webcamImg.alt = 'Webcam stream';
            previewArea.innerHTML = '';
            previewArea.appendChild(webcamImg);
            statusText.textContent = 'Webcam đang chạy...';
        });

        stopWebcam.addEventListener('click', () => {
            if (!webcamImg) return;
            // stop by removing the img
            webcamImg.remove();
            webcamImg = null;
            previewArea.innerHTML = '';
            statusText.textContent = 'Webcam đã dừng.';
        });
    </script>
</body>
</html>
